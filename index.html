<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Zweispieler-Würfelspiel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    :root {
      --p1-color: #d9534f;
      --p2-color: #0275d8;
      --bg: #111;
      --panel-bg: #1c1c1c;
      --accent: #f0ad4e;
      --text: #f7f7f7;
      --muted: #aaa;
      --cell-border: #333;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222, #050505);
      color: var(--text);
    }

    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .player-zone {
      display: flex;
      align-items: stretch;
      padding: 6px 8px;
      gap: 6px;
      background: rgba(0, 0, 0, 0.7);
      border-top: 1px solid #222;
      border-bottom: 1px solid #222;
    }

    .player-zone.top {
      border-bottom: 1px solid #333;
    }

    .player-zone.bottom {
      border-top: 1px solid #333;
    }

    .player-zone .label {
      font-size: 0.8rem;
      margin-bottom: 2px;
      color: var(--muted);
    }

    .player-zone .block {
      flex: 1;
      background: var(--panel-bg);
      border-radius: 6px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .player-zone .block.clickable {
      cursor: pointer;
      border: 1px solid transparent;
    }

    .player-zone .block.clickable.selected {
      border-color: var(--accent);
      box-shadow: 0 0 6px rgba(240, 173, 78, 0.6);
    }

    .count-display {
      font-size: 1.1rem;
      text-align: center;
      font-weight: 600;
    }

    .dice-icon-row {
      display: flex;
      justify-content: center;
      gap: 2px;
      flex-wrap: wrap;
      margin-top: 2px;
      min-height: 16px;
    }

    .dice-mini {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid #666;
      background: #111;
    }

    .center-stats {
      flex: 1.4;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      gap: 4px;
    }

    .counter-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .counter-label {
      font-size: 0.75rem;
      color: var(--muted);
      width: 70px;
      text-align: right;
    }

    .counter-value {
      min-width: 20px;
      text-align: center;
      font-weight: 600;
    }

    .btn {
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.8rem;
      background: #333;
      color: var(--text);
      cursor: pointer;
    }

    .btn.small {
      width: 22px;
      padding: 2px 0;
    }

    .btn.primary {
      background: var(--accent);
      color: #000;
      font-weight: 600;
    }

    .btn:active {
      transform: translateY(1px);
      filter: brightness(0.9);
    }

    #middle {
      flex: 1;
      display: flex;
      padding: 6px;
      gap: 6px;
      min-height: 0;
    }

    .side-panel {
      width: 22%;
      max-width: 110px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .side-card {
      flex: 1;
      background: var(--panel-bg);
      border-radius: 6px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      text-align: center;
      font-size: 0.8rem;
    }

    .side-card h2 {
      font-size: 0.8rem;
      margin: 0 0 4px 0;
      color: var(--muted);
    }

    .status-text {
      font-size: 0.8rem;
      line-height: 1.3;
    }

    #board-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-width: 0;
      position: relative;
    }

    /* Board: 7x7 Zellen, plus je 1 Spalte links/rechts für Bonus-Labels */
    #board {
      width: 100%;
      max-width: 420px;
      aspect-ratio: 1 / 1;
      display: grid;
      grid-template-columns: auto repeat(7, 1fr) auto;
      grid-template-rows: repeat(7, 1fr);
      gap: 2px;
      background: #050505;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.8);
    }

    .cell {
      position: relative;
      border-radius: 4px;
      border: 1px solid var(--cell-border);
      background: #111;
      overflow: hidden;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
    }

    .cell.selected {
      box-shadow: 0 0 6px rgba(240, 173, 78, 0.9);
      border-color: var(--accent);
    }

    /* Feldtypen-Grafiken über ::before */
    .cell::before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0.9;
      pointer-events: none;
      background-size: contain; /* Bild vollständig anzeigen */
      background-position: center;
      background-repeat: no-repeat;
    }

    .cell.type-neutral::before {
      opacity: 0.2;
      background: radial-gradient(circle, #777, #222);
    }

    .cell.type-Set1::before {
      background-image: url("img/Set1/marker.png");
    }

    .cell.type-Set2::before {
      background-image: url("img/Set2/marker.png");
    }

    .cell.type-Set3::before {
      background-image: url("img/Set3/marker.png");
    }

    .cell.type-Set4::before {
      background-image: url("img/Set4/marker.png");
    }

    .cell.type-Set5::before {
      background-image: url("img/Set5/marker.png");
    }
	
	.cell.type-Set6::before {
      background-image: url("img/Set6/marker.png");
    }

    .cell-label {
      position: absolute;
      bottom: 1px;
      right: 2px;
      font-size: 0.55rem;
      color: rgba(255, 255, 255, 0.7);
      text-shadow: 0 0 2px #000;
      pointer-events: none;
    }

    .die {
      position: relative;
      z-index: 2;
      width: 80%;
      /* max-width: 38px; */
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.2);
      font-size: 1rem;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
      background-clip: border-box;
    }

    .die.p1 {
      background: radial-gradient(circle at 30% 20%, #ff877d, var(--p1-color));
    }

    .die.p2 {
      background: radial-gradient(circle at 30% 20%, #79b5ff, var(--p2-color));
    }

    .current-die-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-evenly;
      gap: 4px;
    }

    .current-die-box {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      border: 2px dashed #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
      background-clip: border-box;
    }

    .current-die-box.empty {
      font-size: 0.65rem;
      color: var(--muted);
    }

    /* Bonus-Zeilenlegenden als Grid-Items, die mit den Zeilen mitrutschen */
    .bonus-label {
      font-size: 0.7rem;
      color: var(--accent);
      text-shadow: 0 0 3px #000;
      pointer-events: none;
      padding: 1px 4px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.7);
    }

    .bonus-label-top {
      justify-self: flex-end;
      align-self: center;
    }

    .bonus-label-bottom {
      justify-self: flex-start;
      align-self: center;
    }

    /* Lobby / Neustart */

    #lobby-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 999;
      text-align: center;
      padding: 20px;
    }

    #lobby-overlay h1 {
      margin: 0 0 8px 0;
      font-size: 1.3rem;
    }

    #lobby-overlay p {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    #lobby-config {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
      width: 100%;
      max-width: 260px;
    }

    .lobby-player-config label {
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: stretch;
    }

    #lobby-config select {
      border-radius: 4px;
      border: 1px solid #333;
      background: #000;
      color: var(--text);
      padding: 4px 6px;
      font-size: 0.85rem;
    }

    @media (min-width: 700px) {
      #board {
        max-width: 520px;
      }
    }

    /* rules overlay button mirroring */
    #rules-overlay.player2 #rules-prev,
    #rules-overlay.player2 #rules-next {
      transform: scaleX(-1);
    }
    #rules-overlay.player2 #btn-close-rules {
      transform: rotate(180deg);
    }
    #rules-overlay.player2 {
      flex-direction: column-reverse; /* close button on top */
    }
    /* prev/next stay on left/right; only icons are mirrored */

    /* Online Mode - Player 2 Perspective */
    #app.online-player2 {
      transform: rotate(180deg);
    }

    #app.online-player2 .player-zone {
      transform: rotate(180deg);
    }

    #app.online-player2 #middle {
      transform: rotate(180deg);
    }

    #app.online-player2 .side-panel {
      transform: rotate(180deg);
    }

    #app.online-player2 .side-card {
      transform: rotate(180deg);
    }

    #app.online-player2 #board {
      transform: rotate(180deg);
    }

    #app.online-player2 .die {
      transform: rotate(180deg);
    }

    #app.online-player2 .bonus-label {
      transform: rotate(180deg);
    }



    /* Responsive Layout für schmale Displays */
    @media (max-width: 700px) {
      #middle {
        flex-direction: column;
      }

      .side-panel {
        width: 100%;
        max-width: none;
        flex-direction: row;
      }

      .side-card {
        flex: 1;
      }

      /* when panel is horizontal put Aufwerten button on the right */
      .card-player1 { order: 0; }
      .btn-down-card { order: 1; }
      .current-die-card { order: 2; }
      .btn-up-card { order: 3; }
      .card-player2 { order: 4; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Online Host Overlay -->
    <div id="online-host-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; gap: 20px;">
      <h2 style="margin: 0; font-size: 1.2rem;">Online – Host</h2>
      <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">Deine Verbindungs-ID:</p>
      <div style="background: #1c1c1c; border-radius: 8px; padding: 20px; border: 2px solid var(--accent); text-align: center;">
        <div style="font-size: 1.5rem; font-family: monospace; font-weight: bold; color: var(--accent);" id="host-peer-id">Verbindung wird hergestellt...</div>
      </div>
      <p style="margin: 0; color: var(--muted); font-size: 0.8rem; max-width: 300px; text-align: center;">Teile diese ID mit deinem Mitspieler, damit er sich verbinden kann.</p>
      <button class="btn primary" id="btn-start-as-host" style="padding: 10px 20px; font-size: 1rem;">OK – Spiel starten</button>
      <button class="btn" id="btn-cancel-host" style="padding: 10px 20px; font-size: 1rem;">Abbrechen</button>
    </div>

    <!-- Online Join Overlay -->
    <div id="online-join-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; gap: 20px;">
      <h2 style="margin: 0; font-size: 1.2rem;">Online – Join</h2>
      <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">Gib die Host-ID ein:</p>
      <input type="text" id="join-peer-id-input" placeholder="z.B. abc123xyz" style="border-radius: 4px; border: 1px solid #333; background: #000; color: var(--text); padding: 8px 12px; font-size: 1rem; width: 200px; text-align: center;">
      <button class="btn primary" id="btn-join-peer" style="padding: 10px 20px; font-size: 1rem;">OK – Verbinden</button>
      <button class="btn" id="btn-cancel-join" style="padding: 10px 20px; font-size: 1rem;">Abbrechen</button>
    </div>

    <!-- Rules/Karten Overlay -->
    <div id="rules-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;">
      <div style="flex: 1; display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 20px;">
        <div id="rules-prev" style="width: 60px; height: 60px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent); user-select: none;">◀</div>
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; max-width: 90%;">
          <img id="rules-image" src="" style="max-width: 100%; max-height: 80vh; object-fit: contain;" alt="Rules">
        </div>
        <div id="rules-next" style="width: 60px; height: 60px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent); user-select: none;">▶</div>
      </div>
      <button class="btn primary" id="btn-close-rules" style="margin-bottom: 40px; padding: 10px 20px; font-size: 1rem;">Zurück zum Spiel</button>
    </div>
    <div id="lobby-overlay">
      <h1>2‑Spieler‑Würfelspiel</h1>
      <p>Lokales Spiel auf einem Gerät. Wähle pro Spieler ein Würfel‑Set und starte das Match.</p>

      <div id="lobby-config">
        <div class="lobby-player-config">
          <label>
            Spielmodus
            <select id="game-mode-select">
              <option value="solo">Solo</option>
              <option value="duel">Duell</option>
              <option value="online-host">Online – Host</option>
              <option value="online-join">Online – Join</option>
            </select>
          </label>
        </div>
        <div class="lobby-player-config">
          <label>
            Spieler 1 – Würfel‑Set
            <select id="p1-dice-set"></select>
          </label>
        </div>
        <div class="lobby-player-config">
          <label>
            Spieler 2 – Würfel‑Set
            <select id="p2-dice-set"></select>
          </label>
        </div>
      </div>

      <button class="btn primary" id="start-game-btn">Spiel starten</button>
    </div>

    <!-- Spielerzone 2 (oben) -->
    <div class="player-zone top" data-player="2">
      <div class="block clickable" id="p2-reserve">
        <div class="label">Spieler 2 – Reserve</div>
        <div class="count-display" id="p2-reserve-count">15</div>
        <div class="dice-icon-row" id="p2-reserve-icons"></div>
      </div>
      <div class="center-stats">
        <div class="counter-row">
          <span class="counter-label">Triggerpunkte</span>
          <button class="btn small" data-counter="p2-trigger" data-delta="-1">−</button>
          <span class="counter-value" id="p2-trigger">0</span>
          <button class="btn small" data-counter="p2-trigger" data-delta="1">+</button>
        </div>
        <div class="counter-row">
          <span class="counter-label">Siegpunkte</span>
          <button class="btn small" data-counter="p2-victory" data-delta="-1">−</button>
          <span class="counter-value" id="p2-victory">0</span>
          <button class="btn small" data-counter="p2-victory" data-delta="1">+</button>
        </div>
      </div>
      <div class="block clickable" id="p2-exile">
        <div class="label">Spieler 2 – Exil</div>
        <div class="count-display" id="p2-exile-count">0</div>
        <div class="dice-icon-row" id="p2-exile-icons"></div>
      </div>
    </div>

    <!-- Mitte: Seitenleisten + Spielfeld -->
    <div id="middle">
      <!-- Obere Side-Panel -->
      <div class="side-panel">
        <div class="side-card">
          <!-- <h2>Lobby</h2> -->
          <button class="btn" id="btn-lobby">Zur Lobby</button>
        </div>
        <div class="side-card">
          <h2>Spielzustand</h2>
          <div class="status-text" id="status-text">Spieler 1 ist am Zug.</div>
          <div class="status-text" id="round-text" style="margin-top: 8px; font-size: 0.75rem; color: var(--muted);">Runde: 1</div>
        </div>
        <div class="side-card">
          <!-- <h2>Zug</h2> -->
          <button class="btn primary" id="btn-end-turn">Zug beenden</button>
        </div>
      </div>

      <!-- Spielfeld -->
      <div id="board-container">
        <div id="board"></div>
      </div>

      <!-- Untere Side-Panel -->
      <div class="side-panel">
        <div class="side-card card-player2">
          <button class="btn" id="btn-player2-cards">Spieler 2<br />Karten</button>
        </div>
        <div class="side-card btn-up-card">
            <button class="btn primary" id="btn-die-plus">+</button>
        </div>
        <div class="side-card current-die-card">
          <!-- <h2>Gewählter Würfel</h2> -->
          <div class="current-die-view">
            <div class="current-die-box empty" id="current-die-box">
              Kein<br />Würfel
            </div>
            <div id="current-die-info" style="font-size:0.7rem;color:var(--muted);text-align:center;">
              Wähle einen Würfel.
            </div>
          </div>
        </div>
        <div class="side-card btn-down-card">
          <button class="btn primary" id="btn-die-minus">-</button>
        </div>
        <div class="side-card card-player1">
          <button class="btn" id="btn-player1-cards">Spieler 1<br />Karten</button>
        </div>
      </div>
    </div>

    <!-- Spielerzone 1 (unten) -->
    <div class="player-zone bottom" data-player="1">
      <div class="block clickable" id="p1-reserve">
        <div class="label">Spieler 1 – Reserve</div>
        <div class="count-display" id="p1-reserve-count">15</div>
        <div class="dice-icon-row" id="p1-reserve-icons"></div>
      </div>
      <div class="center-stats">
        <div class="counter-row">
          <span class="counter-label">Triggerpunkte</span>
          <button class="btn small" data-counter="p1-trigger" data-delta="-1">−</button>
          <span class="counter-value" id="p1-trigger">0</span>
          <button class="btn small" data-counter="p1-trigger" data-delta="1">+</button>
        </div>
        <div class="counter-row">
          <span class="counter-label">Siegpunkte</span>
          <button class="btn small" data-counter="p1-victory" data-delta="-1">−</button>
          <span class="counter-value" id="p1-victory">0</span>
          <button class="btn small" data-counter="p1-victory" data-delta="1">+</button>
        </div>
      </div>
      <div class="block clickable" id="p1-exile">
        <div class="label">Spieler 1 – Exil</div>
        <div class="count-display" id="p1-exile-count">0</div>
        <div class="dice-icon-row" id="p1-exile-icons"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Würfel-Sets: manuell zu deinen /img/<SetName>/ Ordnern passend halten ---
    const DICE_SETS = [
      { id: "numbers", label: "Standard (Zahlen)" },
      { id: "Set1", label: "Set 1" },
      { id: "Set2", label: "Set 2" },
      { id: "Set3", label: "Set 3" },
      { id: "Set4", label: "Set 4" },
      { id: "Set5", label: "Set 5" },
      { id: "Set6", label: "Set 6" }
    ];

    // --- Spielzustand ---
    const SIZE = 7;
    const FIELD_TYPES = [
      "neutral",
      "Set1",
      "Set2",
      "Set3",
      "Set4",
      "Set5",
	  "Set6",
    ];

    const state = {
      currentPlayer: 1,
      gameOver: false,
      gameMode: "duel",
      board: [],
      players: {
        1: { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: "numbers" },
        2: { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: "numbers" },
      },
      selected: null,
      roundNumber: 1,
    };

    const boardEl = document.getElementById("board");
    const statusTextEl = document.getElementById("status-text");

    const currentDieBox = document.getElementById("current-die-box");
    const currentDieInfo = document.getElementById("current-die-info");

    // --- Board & Feldtypen ---

    function initBoardState() {
      state.board = [];
      for (let r = 0; r < SIZE; r++) {
        const row = [];
        for (let c = 0; c < SIZE; c++) {
          row.push({
            owner: null,
            value: null,
            type: "neutral",
          });
        }
        state.board.push(row);
      }
    }

    function buildBoardDOM() {
      boardEl.innerHTML = "";
      // Spielfeld-Zellen: Grid‑Position explizit setzen (Spalten 2–8 sind das eigentliche Feld)
      for (let r = 0; r < SIZE; r++) {
        for (let c = 0; c < SIZE; c++) {
          const cell = document.createElement("div");
          cell.className = "cell type-neutral";
          cell.dataset.row = r;
          cell.dataset.col = c;

          // Grid-Position: Zeilen 1–7, Spalten 2–8 (1 & 9 sind für Bonus-Labels)
          cell.style.gridRow = String(r + 1);
          cell.style.gridColumn = String(c + 2);

          const label = document.createElement("div");
          label.className = "cell-label";
          label.textContent = "";
          cell.appendChild(label);

          cell.addEventListener("click", () => onCellClick(r, c));
          boardEl.appendChild(cell);
        }
      }

      // Bonus-Zeilenlegenden als Grid-Items hinzufügen
      createRowBonusLabels();
    }

    function createRowBonusLabels() {
      // Oben rechts: +3 (oberste Zeile), +2, +1
      const topTexts = ["+3", "+2", "+1"];
      for (let i = 0; i < 3; i++) {
        const label = document.createElement("div");
        label.className = "bonus-label bonus-label-top";
        label.textContent = topTexts[i];
        label.style.gridRow = String(i + 1); // Zeilen 1,2,3
        label.style.gridColumn = "9";        // rechte Label-Spalte
        boardEl.appendChild(label);
      }

      // Links unten: unterste +3, zweitunterste +2, drittunterste +1
      // Anzeige von oben nach unten: +1, +2, +3 bei Grid-Zeilen 5,6,7
      const bottomTexts = ["+1", "+2", "+3"];
      for (let i = 0; i < 3; i++) {
        const label = document.createElement("div");
        label.className = "bonus-label bonus-label-bottom";
        label.textContent = bottomTexts[i];
        label.style.gridRow = String(5 + i); // 5,6,7
        label.style.gridColumn = "1";        // linke Label-Spalte
        boardEl.appendChild(label);
      }
    }

    function updateBoardDOM() {
      for (let r = 0; r < SIZE; r++) {
        for (let c = 0; c < SIZE; c++) {
          const idx = r * SIZE + c;
          const cellEl = boardEl.children[idx];
          const data = state.board[r][c];

          cellEl.classList.remove(
            "type-neutral",
            "type-Set1",
            "type-Set2",
            "type-Set3",
            "type-Set4",
            "type-Set5",
			"type-Set6",
            "selected"
          );
          cellEl.classList.add("type-" + data.type);

          if (
            state.selected &&
            state.selected.type === "board" &&
            state.selected.row === r &&
            state.selected.col === c
          ) {
            cellEl.classList.add("selected");
          }

          const labelEl = cellEl.querySelector(".cell-label");
          labelEl.textContent = getFieldTypeShortLabel(data.type);

          const oldDie = cellEl.querySelector(".die");
          if (oldDie) oldDie.remove();

          if (data.owner != null && data.value != null) {
            const owner = data.owner;
            const player = state.players[owner];
            const diceSet = player && player.diceSet ? player.diceSet : "numbers";

            const die = document.createElement("div");
            die.className = "die " + (owner === 1 ? "p1" : "p2");

if (diceSet === "numbers") {
  // Zahlenwürfel mit Spieler-spezifischen Farben wie im updateCurrentDieView
  die.textContent = data.value;
  die.style.backgroundImage = "none";
  die.style.background =
    owner === 1
      ? "radial-gradient(circle at 30% 20%, #ff877d, var(--p1-color))"
      : "radial-gradient(circle at 30% 20%, #79b5ff, var(--p2-color))";
  die.style.color = "#fff";
  if (state.gameMode === "duel" && owner === 2) {
    die.style.transform = "rotate(180deg)";
  }
} else {
  // Bildwürfel
  die.textContent = "";
  const imgPath = `img/${diceSet}/${data.value}.png`;
  const img = document.createElement("img");
  img.src = imgPath;
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.borderRadius = "6px";
  img.alt = `Würfel ${data.value}`;
  if (state.gameMode === "duel" && owner === 2) {
    img.style.transform = "rotate(180deg)";
  }
  die.appendChild(img);
}

            cellEl.appendChild(die);
          }
        }
      }
    }

    function getFieldTypeShortLabel(type) {
      switch (type) {
        case "neutral":
          return "";
        case "Set1":
          return "";
        case "Set2":
          return "S2";
        case "Set3":
          return "S3";
        case "Set4":
          return "S4";
        case "Set5":
          return "S5";
		case "Set6":
          return "S6";
        default:
          return "";
      }
    }

    function setStatus(text) {
      statusTextEl.textContent = text;
    }

    function refreshPlayerPanels() {
      [1, 2].forEach((p) => {
        document.getElementById(`p${p}-reserve-count`).textContent =
          state.players[p].reserve;
        document.getElementById(`p${p}-exile-count`).textContent =
          state.players[p].exile;
        document.getElementById(`p${p}-trigger`).textContent =
          state.players[p].trigger;
        document.getElementById(`p${p}-victory`).textContent =
          state.players[p].victory;

        renderMiniDice(`p${p}-reserve-icons`, state.players[p].reserve);
        renderMiniDice(`p${p}-exile-icons`, state.players[p].exile);
      });

      document
        .querySelectorAll(".player-zone")
        .forEach((zone) => (zone.style.outline = "none"));
      const currentZone = document.querySelector(
        `.player-zone[data-player="${state.currentPlayer}"]`
      );
      if (currentZone) {
        currentZone.style.outline = "2px solid var(--accent)";
        currentZone.style.outlineOffset = "-2px";
      }
      
      // Online-Modus: Elemente für inaktiven Spieler deaktivieren
      updateOnlineUIState();
    }

    function updateOnlineUIState() {
      if (state.gameMode !== "online") {
        enableAllGameElements();
        return;
      }
      
      if (state.currentPlayer === onlineState.localPlayer) {
        // Aktueller Spieler: alle Elemente aktiv
        enableAllGameElements();
      } else {
        // Nicht-aktueller Spieler: nur bestimmte Buttons aktiv
        disableGameElementsForInactivePlayer();
      }
    }

    function enableAllGameElements() {
      // Board-Zellen
      document.querySelectorAll(".cell").forEach(cell => {
        cell.style.pointerEvents = "auto";
        cell.style.opacity = "1";
      });
      
      // Reserve und Exil
      document.querySelectorAll(".block.clickable").forEach(block => {
        block.style.pointerEvents = "auto";
        block.style.opacity = "1";
      });
      
      // Counter-Buttons
      document.querySelectorAll("button[data-counter]").forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = "1";
      });
      
      // End Turn Button
      document.getElementById("btn-end-turn").disabled = false;
      document.getElementById("btn-end-turn").style.opacity = "1";
      
      // Dice Plus/Minus Buttons
      document.getElementById("btn-die-plus").disabled = false;
      document.getElementById("btn-die-plus").style.opacity = "1";
      document.getElementById("btn-die-minus").disabled = false;
      document.getElementById("btn-die-minus").style.opacity = "1";
    }

    function disableGameElementsForInactivePlayer() {
      // Board-Zellen deaktivieren
      document.querySelectorAll(".cell").forEach(cell => {
        cell.style.pointerEvents = "none";
        cell.style.opacity = "0.5";
      });
      
      // Reserve und Exil deaktivieren
      document.querySelectorAll(".block.clickable").forEach(block => {
        block.style.pointerEvents = "none";
        block.style.opacity = "0.5";
      });
      
      // Counter-Buttons deaktivieren
      document.querySelectorAll("button[data-counter]").forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = "0.5";
      });
      
      // End Turn Button deaktivieren
      document.getElementById("btn-end-turn").disabled = true;
      document.getElementById("btn-end-turn").style.opacity = "0.5";
      
      // Dice Plus/Minus Buttons deaktivieren
      document.getElementById("btn-die-plus").disabled = true;
      document.getElementById("btn-die-plus").style.opacity = "0.5";
      document.getElementById("btn-die-minus").disabled = true;
      document.getElementById("btn-die-minus").style.opacity = "0.5";
      
      // Die folgenden Buttons BLEIBEN aktiv:
      // - btn-player1-cards
      // - btn-player2-cards
      // - btn-lobby (eigentlich: zurück zur Lobby)
    }

    function renderMiniDice(containerId, count) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const maxIcons = Math.min(count, 5);
      for (let i = 0; i < maxIcons; i++) {
        const d = document.createElement("div");
        d.className = "dice-mini";
        container.appendChild(d);
      }
      if (count > maxIcons) {
        const more = document.createElement("span");
        more.style.fontSize = "0.65rem";
        more.style.color = "var(--muted)";
        more.textContent = `+${count - maxIcons}`;
        container.appendChild(more);
      }
    }

    function clearSelection() {
      state.selected = null;
      updateBoardDOM();
      updateCurrentDieView();
      document
        .querySelectorAll(".player-zone .block.clickable")
        .forEach((b) => b.classList.remove("selected"));
    }

    function onCellClick(r, c) {
      if (state.gameOver) return;
      
      // Im Online-Modus: nur eigener Spieler darf Züge machen
      if (state.gameMode === "online" && state.currentPlayer !== onlineState.localPlayer) {
        return;
      }
      
      const cell = state.board[r][c];
      const hasDie = cell.owner !== null;

      if (hasDie) {
        if (
          state.selected &&
          state.selected.type === "board" &&
          state.selected.row === r &&
          state.selected.col === c
        ) {
          clearSelection();
          return;
        }
        state.selected = { type: "board", row: r, col: c };
        updateBoardDOM();
        updateCurrentDieView();
        return;
      }

      if (state.selected) {
        if (state.selected.type === "board") {
          const from = state.board[state.selected.row][state.selected.col];
          if (from && from.owner != null && from.value != null) {
            cell.owner = from.owner;
            cell.value = from.value;
            from.owner = null;
            from.value = null;
            clearSelection();
            updateBoardDOM();
            
            // Zustand an anderen Spieler senden
            if (state.gameMode === "online") {
              sendGameState();
            }
            return;
          }
        }

        if (state.selected.type === "reserve") {
          const p = state.selected.player;
          if (state.players[p].reserve > 0) {
            state.players[p].reserve--;
            cell.owner = p;
            cell.value = 1;
            clearSelection();
            refreshPlayerPanels();
            updateBoardDOM();
            
            // Zustand an anderen Spieler senden
            if (state.gameMode === "online") {
              sendGameState();
            }
            return;
          }
        }
        if (state.selected.type === "exile") {
          const p = state.selected.player;
          if (state.players[p].exile > 0) {
            state.players[p].exile--;
            cell.owner = p;
            cell.value = 1;
            clearSelection();
            refreshPlayerPanels();
            updateBoardDOM();
            
            // Zustand an anderen Spieler senden
            if (state.gameMode === "online") {
              sendGameState();
            }
            return;
          }
        }
      }

      const index = FIELD_TYPES.indexOf(cell.type);
      const nextIndex = (index + 1) % FIELD_TYPES.length;
      cell.type = FIELD_TYPES[nextIndex];
      updateBoardDOM();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function onReserveClick(player) {
      if (state.gameOver) return;
      const block = document.getElementById(`p${player}-reserve`);
      const wasSelected =
        state.selected &&
        state.selected.type === "reserve" &&
        state.selected.player === player;

      clearSelection();

      if (!wasSelected) {
        if (state.players[player].reserve <= 0) return;
        state.selected = { type: "reserve", player };
        block.classList.add("selected");
      }

      updateCurrentDieView();
    }

    function onExileClick(player) {
      if (state.gameOver) return;
      const block = document.getElementById(`p${player}-exile`);
      const wasSelected =
        state.selected &&
        state.selected.type === "exile" &&
        state.selected.player === player;

      clearSelection();

      if (!wasSelected) {
        if (state.players[player].exile <= 0) return;
        state.selected = { type: "exile", player };
        block.classList.add("selected");
      }

      updateCurrentDieView();
    }

    function moveSelectedBoardDieToReserve(player) {
      if (!state.selected || state.selected.type !== "board") return;
      const { row, col } = state.selected;
      const cell = state.board[row][col];
      if (cell.owner !== player) return;

      state.players[player].reserve++;
      cell.owner = null;
      cell.value = null;
      clearSelection();
      refreshPlayerPanels();
      updateBoardDOM();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function moveSelectedBoardDieToExile(player) {
      if (!state.selected || state.selected.type !== "board") return;
      const { row, col } = state.selected;
      const cell = state.board[row][col];
      if (cell.owner !== player) return;

      state.players[player].exile++;
      cell.owner = null;
      cell.value = null;
      clearSelection();
      refreshPlayerPanels();
      updateBoardDOM();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function moveReserveToExile(player) {
      if (state.players[player].reserve <= 0) return;
      state.players[player].reserve--;
      state.players[player].exile++;
      clearSelection();
      refreshPlayerPanels();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function moveExileToReserve(player) {
      if (state.players[player].exile <= 0) return;
      state.players[player].exile--;
      state.players[player].reserve++;
      clearSelection();
      refreshPlayerPanels();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function rotateSelectedDie(delta) {
      if (state.gameOver) return;
      
      // Im Online-Modus: nur eigener Spieler darf Züge machen
      if (state.gameMode === "online" && state.currentPlayer !== onlineState.localPlayer) {
        return;
      }
      
      if (!state.selected || state.selected.type !== "board") return;
      const { row, col } = state.selected;
      const cell = state.board[row][col];
      if (cell.owner == null || cell.value == null) return;
      let v = cell.value + delta;
      if (v < 1) v = 6;
      if (v > 6) v = 1;
      cell.value = v;
      updateBoardDOM();
      updateCurrentDieView();
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function updateCurrentDieView() {
      if (!state.selected || state.selected.type !== "board") {
        currentDieBox.classList.add("empty");
        currentDieBox.innerHTML = "Kein<br />Würfel";
        currentDieBox.style.backgroundImage = "none";
        currentDieBox.style.background = "transparent";
        currentDieBox.style.borderStyle = "dashed";
        currentDieInfo.textContent =
          "Wähle einen Würfel.";
        return;
      }
      const { row, col } = state.selected;
      const cell = state.board[row][col];
      if (cell.owner == null || cell.value == null) {
        currentDieBox.classList.add("empty");
        currentDieBox.innerHTML = "Kein<br />Würfel";
        currentDieBox.style.backgroundImage = "none";
        currentDieBox.style.background = "transparent";
        currentDieBox.style.borderStyle = "dashed";
        currentDieInfo.textContent =
          "Wähle einen Würfel.";
        return;
      }

      const player = state.players[cell.owner];
      const diceSet = player && player.diceSet ? player.diceSet : "numbers";

      currentDieBox.classList.remove("empty");
      currentDieBox.style.borderStyle = "solid";

if (diceSet === "numbers") {
  currentDieBox.innerHTML = String(cell.value);
  currentDieBox.style.backgroundImage = "none";
  currentDieBox.style.background =
    cell.owner === 1
      ? "radial-gradient(circle at 30% 20%, #ff877d, var(--p1-color))"
      : "radial-gradient(circle at 30% 20%, #79b5ff, var(--p2-color))";
  currentDieBox.style.color = "#fff";
  if (state.gameMode === "duel" && cell.owner === 2) {
    currentDieBox.style.transform = "rotate(180deg)";
  } else {
    currentDieBox.style.transform = "none";
  }
} else {
currentDieBox.innerHTML = "";
const imgPath = `img/${diceSet}/${cell.value}.png`;
const img = document.createElement("img");
img.src = imgPath;
img.style.width = "100%";
img.style.height = "100%";
img.style.objectFit = "contain";
img.style.borderRadius = "6px";
img.alt = `Würfel ${cell.value}`;
if (state.gameMode === "duel" && cell.owner === 2) {
  img.style.transform = "rotate(180deg)";
}
currentDieBox.appendChild(img);
        currentDieBox.style.color = "transparent";
      }

      currentDieInfo.textContent =
        "Spieler " + cell.owner + " – Wert " + cell.value;
    }

    function onCounterButtonClick(counterId, delta) {
      if (state.gameOver && !counterId.endsWith("victory")) return;

      let player = counterId.startsWith("p1") ? 1 : 2;
      const field = counterId.endsWith("trigger") ? "trigger" : "victory";
      let value = state.players[player][field] + delta;
      if (value < 0) value = 0;
      if (value > 10) value = 10;
      state.players[player][field] = value;
      document.getElementById(counterId).textContent = value;

      if (field === "victory" && value >= 10 && !state.gameOver) {
        state.gameOver = true;
        setStatus("Spieler " + player + " hat gewonnen!");
      }
      
      // Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function endTurn() {
      if (state.gameOver) return;
      
      // Wenn Spieler 2 seinen Zug beendet, Runde erhöhen
      if (state.currentPlayer === 2) {
        state.roundNumber++;
      }
      
      state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
      clearSelection();
      setStatus("Spieler " + state.currentPlayer + " ist am Zug.");
      updateRoundDisplay();
      refreshPlayerPanels();
      
      // In Online-Modus: Zustand an anderen Spieler senden
      if (state.gameMode === "online") {
        sendGameState();
      }
    }

    function updateRoundDisplay() {
      document.getElementById("round-text").textContent = "Runde: " + state.roundNumber;
    }

    // --- Lobby / Würfel-Set-Auswahl ---

    function initLobbyDiceSets() {
      const p1Select = document.getElementById("p1-dice-set");
      const p2Select = document.getElementById("p2-dice-set");

      [p1Select, p2Select].forEach((select) => {
        if (!select) return;
        select.innerHTML = "";
        DICE_SETS.forEach((set) => {
          const opt = document.createElement("option");
          opt.value = set.id;
          opt.textContent = set.label;
          select.appendChild(opt);
        });
        select.value = "numbers";
      });
    }

    const lobbyOverlay = document.getElementById("lobby-overlay");
    const startGameBtn = document.getElementById("start-game-btn");
    startGameBtn.addEventListener("click", () => {
      startNewGame();
      lobbyOverlay.style.display = "none";
    });

    document.getElementById("btn-lobby").addEventListener("click", () => {
      document.getElementById("app").classList.remove("online-player2");
      lobbyOverlay.style.display = "flex";
    });

    function startNewGame() {
      const p1Select = document.getElementById("p1-dice-set");
      const p2Select = document.getElementById("p2-dice-set");
      const gameModeSelect = document.getElementById("game-mode-select");
      const p1Set = p1Select ? p1Select.value : "numbers";
      const p2Set = p2Select ? p2Select.value : "numbers";
      const gameMode = gameModeSelect ? gameModeSelect.value : "duel";

      state.currentPlayer = 1;
      state.gameOver = false;
      state.gameMode = gameMode;
      state.roundNumber = 1;
      state.players[1] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p1Set };
      state.players[2] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p2Set };

      initBoardState();
      buildBoardDOM();
      updateBoardDOM();
      refreshPlayerPanels();
      updateRoundDisplay();
      clearSelection();
      setStatus("Spieler 1 ist am Zug.");
    }

    // --- Rules/Karten Overlay ---

    let rulesState = {
      currentPlayer: null,
      currentImageIndex: 0,
      images: []
    };

    // Verfügbare Bilder pro Set (angenommen: rules-1.png bis rules-6.png)
    const RULES_PER_SET = {
      "numbers": [1, 2, 3, 4, 5, 6],
      "Set1": [1, 2, 3, 4, 5, 6],
      "Set2": [1, 2, 3, 4, 5, 6],
      "Set3": [1, 2, 3, 4, 5, 6],
      "Set4": [1, 2, 3, 4, 5, 6],
      "Set5": [1, 2, 3, 4, 5, 6],
      "Set6": [1, 2, 3, 4, 5, 6],
    };

    function openRulesOverlay(player) {
      const diceSet = state.players[player].diceSet || "numbers";
      const imageList = RULES_PER_SET[diceSet] || [1, 2, 3, 4, 5, 6];
      const folder = diceSet === "numbers" ? "numbers" : diceSet;
      
      rulesState.currentPlayer = player;
      rulesState.currentImageIndex = 0;
      rulesState.images = imageList.map(i => `img/${folder}/rules/rules-${i}.png`);
      
      const overlay = document.getElementById("rules-overlay");
      overlay.style.display = "flex";
      overlay.classList.toggle("player2", state.gameMode === "duel" && state.currentPlayer === 2);
      
      showRulesImage();
    }

    function closeRulesOverlay() {
      const overlay = document.getElementById("rules-overlay");
      overlay.style.display = "none";
    }

    function showRulesImage() {
      if (rulesState.images.length === 0) return;
      
      const img = document.getElementById("rules-image");
      const imagePath = rulesState.images[rulesState.currentImageIndex];
      img.src = imagePath;
      
      // Rotation abhängig vom aktuellen Spieler und Spielmodus:
      // Im Duell-Modus sitzt Spieler 2 oben, daher Bilder drehen, damit er sie richtig herum sieht
      if (state.gameMode === "duel" && state.currentPlayer === 2) {
        img.style.transform = "rotate(180deg)";
      } else {
        img.style.transform = "none";
      }
    }

    function nextRulesImage() {
      rulesState.currentImageIndex = (rulesState.currentImageIndex + 1) % rulesState.images.length;
      showRulesImage();
    }

    function prevRulesImage() {
      rulesState.currentImageIndex = (rulesState.currentImageIndex - 1 + rulesState.images.length) % rulesState.images.length;
      showRulesImage();
    }

    // --- Event-Handler für Reserve/Exil etc. ---

    function attachBoardListeners() {
      document
        .getElementById("p1-reserve")
        .addEventListener("click", () => {
          if (
            state.selected &&
            state.selected.type === "board" &&
            state.board[state.selected.row][state.selected.col].owner === 1
          ) {
            moveSelectedBoardDieToReserve(1);
          } else if (
            state.selected &&
            state.selected.type === "exile" &&
            state.selected.player === 1
          ) {
            moveExileToReserve(1);
          } else if (
            state.selected &&
            state.selected.type === "reserve" &&
            state.selected.player === 1
          ) {
            clearSelection();
          } else {
            onReserveClick(1);
          }
        });

      document
        .getElementById("p2-reserve")
        .addEventListener("click", () => {
          if (
            state.selected &&
            state.selected.type === "board" &&
            state.board[state.selected.row][state.selected.col].owner === 2
          ) {
            moveSelectedBoardDieToReserve(2);
          } else if (
            state.selected &&
            state.selected.type === "exile" &&
            state.selected.player === 2
          ) {
            moveExileToReserve(2);
          } else if (
            state.selected &&
            state.selected.type === "reserve" &&
            state.selected.player === 2
          ) {
            clearSelection();
          } else {
            onReserveClick(2);
          }
        });

      document.getElementById("p1-exile").addEventListener("click", () => {
        if (
          state.selected &&
          state.selected.type === "board" &&
          state.board[state.selected.row][state.selected.col].owner === 1
        ) {
          moveSelectedBoardDieToExile(1);
        } else if (
          state.selected &&
          state.selected.type === "reserve" &&
          state.selected.player === 1
        ) {
          moveReserveToExile(1);
        } else if (
          state.selected &&
          state.selected.type === "exile" &&
          state.selected.player === 1
        ) {
          clearSelection();
        } else {
          onExileClick(1);
        }
      });

      document.getElementById("p2-exile").addEventListener("click", () => {
        if (
          state.selected &&
          state.selected.type === "board" &&
          state.board[state.selected.row][state.selected.col].owner === 2
        ) {
          moveSelectedBoardDieToExile(2);
        } else if (
          state.selected &&
          state.selected.type === "reserve" &&
          state.selected.player === 2
        ) {
          moveReserveToExile(2);
        } else if (
          state.selected &&
          state.selected.type === "exile" &&
          state.selected.player === 2
        ) {
          clearSelection();
        } else {
          onExileClick(2);
        }
      });

      document.querySelectorAll("button[data-counter]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-counter");
          const delta = parseInt(btn.getAttribute("data-delta"), 10);
          onCounterButtonClick(id, delta);
        });
      });

      document
        .getElementById("btn-end-turn")
        .addEventListener("click", endTurn);

      document
        .getElementById("btn-die-plus")
        .addEventListener("click", () => rotateSelectedDie(1));
      document
        .getElementById("btn-die-minus")
        .addEventListener("click", () => rotateSelectedDie(-1));

      document
        .getElementById("btn-player1-cards")
        .addEventListener("click", () => openRulesOverlay(1));
      document
        .getElementById("btn-player2-cards")
        .addEventListener("click", () => openRulesOverlay(2));

      document
        .getElementById("btn-close-rules")
        .addEventListener("click", closeRulesOverlay);

      document
        .getElementById("rules-prev")
        .addEventListener("click", prevRulesImage);
      document
        .getElementById("rules-next")
        .addEventListener("click", nextRulesImage);

      // also support clicking left/right half of the image itself
      document
        .getElementById("rules-image")
        .addEventListener("click", (e) => {
          const rect = e.target.getBoundingClientRect();
          const x = e.clientX - rect.left;
          if (x < rect.width / 2) prevRulesImage();
          else nextRulesImage();
        });
    }

    // --- Init ---

    initBoardState();
    buildBoardDOM();
    updateBoardDOM();
    refreshPlayerPanels();
    attachBoardListeners();
    initLobbyDiceSets();

    // --- Online Mode / PeerJS ---

    const onlineState = {
      peer: null,
      connection: null,
      isHost: false,
      isJoining: false,
      myPeerId: null,
      remotePeerId: null,
      localPlayer: null,
    };

    function initPeer() {
      return new Promise((resolve) => {
        onlineState.peer = new Peer();
        onlineState.peer.on("open", (id) => {
          onlineState.myPeerId = id;
          resolve(id);
        });
        onlineState.peer.on("connection", (conn) => {
          handleIncomingConnection(conn);
        });
      });
    }

    function handleIncomingConnection(conn) {
      conn.on("open", () => {
        onlineState.connection = conn;
        onlineState.remotePeerId = conn.peer;
      });
      conn.on("data", (data) => {
        handleRemoteGameState(data);
      });
      conn.on("close", () => {
        alert("Verbindung zum Mitspieler unterbrochen!");
        goBackToLobby();
      });
      conn.on("error", (err) => {
        console.error("Connection error:", err);
      });
    }

    function connectToHost(hostPeerId) {
      return new Promise((resolve, reject) => {
        const conn = onlineState.peer.connect(hostPeerId);
        conn.on("open", () => {
          onlineState.connection = conn;
          onlineState.remotePeerId = hostPeerId;
          resolve();
        });
        conn.on("data", (data) => {
          handleRemoteGameState(data);
        });
        conn.on("close", () => {
          alert("Verbindung zum Host unterbrochen!");
          goBackToLobby();
        });
        conn.on("error", (err) => {
          reject(err);
        });
      });
    }

    function sendGameState() {
      if (onlineState.connection && onlineState.connection.open) {
        const gameData = {
          state: state,
          currentPlayer: state.currentPlayer,
          selected: state.selected,
        };
        onlineState.connection.send(gameData);
      }
    }

    function handleRemoteGameState(data) {
      // State updaten, unabhängig davon, wer am Zug ist
      state.board = data.state.board;
      state.players = data.state.players;
      state.currentPlayer = data.currentPlayer;
      state.selected = data.selected;
      state.roundNumber = data.state.roundNumber;
      
      updateBoardDOM();
      refreshPlayerPanels();
      updateRoundDisplay();
      setStatus("Spieler " + state.currentPlayer + " ist am Zug.");
    }

    function updatePerspective() {
      const app = document.getElementById("app");
      if (state.gameMode === "online" && onlineState.localPlayer === 2) {
        app.classList.add("online-player2");
      } else {
        app.classList.remove("online-player2");
      }
    }

    async function startGameAsHost(p1Set, p2Set) {
      await initPeer();
      document.getElementById("host-peer-id").textContent = onlineState.myPeerId;
      const hostOverlay = document.getElementById("online-host-overlay");
      hostOverlay.style.display = "flex";
      
      return new Promise((resolve) => {
        document.getElementById("btn-start-as-host").onclick = async () => {
          onlineState.isHost = true;
          onlineState.localPlayer = 1;
          hostOverlay.style.display = "none";
          
          const lobbyOverlay = document.getElementById("lobby-overlay");
          lobbyOverlay.style.display = "none";
          
          state.currentPlayer = 1;
          state.gameOver = false;
          state.gameMode = "online";
          state.roundNumber = 1;
          state.players[1] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p1Set };
          state.players[2] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p2Set };
          
          initBoardState();
          buildBoardDOM();
          updateBoardDOM();
          refreshPlayerPanels();
          updateRoundDisplay();
          updatePerspective();
          clearSelection();
          setStatus("Spieler 1 ist am Zug. Warte auf Mitspieler...");
          
          resolve();
        };
      });
    }

    async function startGameAsJoin(p1Set, p2Set) {
      await initPeer();
      const joinOverlay = document.getElementById("online-join-overlay");
      joinOverlay.style.display = "flex";
      
      return new Promise((resolve, reject) => {
        document.getElementById("btn-join-peer").onclick = async () => {
          const hostId = document.getElementById("join-peer-id-input").value.trim();
          if (!hostId) {
            alert("Bitte gib eine Host-ID ein.");
            return;
          }
          
          try {
            await connectToHost(hostId);
            onlineState.isJoining = true;
            onlineState.localPlayer = 2;
            joinOverlay.style.display = "none";
            
            const lobbyOverlay = document.getElementById("lobby-overlay");
            lobbyOverlay.style.display = "none";
            
            state.currentPlayer = 1;
            state.gameOver = false;
            state.gameMode = "online";
            state.roundNumber = 1;
            state.players[1] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p1Set };
            state.players[2] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p2Set };
            
            initBoardState();
            buildBoardDOM();
            updateBoardDOM();
            refreshPlayerPanels();
            updateRoundDisplay();
            updatePerspective();
            clearSelection();
            setStatus("Mit Host verbunden. Warte auf Spielstart...");
            
            resolve();
          } catch (err) {
            alert("Fehler beim Verbinden: " + err);
            reject(err);
          }
        };
      });
    }

    function goBackToLobby() {
      if (onlineState.connection) {
        onlineState.connection.close();
      }
      if (onlineState.peer) {
        onlineState.peer.destroy();
        onlineState.peer = null;
      }
      onlineState.connection = null;
      onlineState.myPeerId = null;
      onlineState.remotePeerId = null;
      onlineState.isHost = false;
      onlineState.isJoining = false;
      
      document.getElementById("app").classList.remove("online-player2");
      document.getElementById("online-host-overlay").style.display = "none";
      document.getElementById("online-join-overlay").style.display = "none";
      document.getElementById("lobby-overlay").style.display = "flex";
    }

    document.getElementById("btn-cancel-host").addEventListener("click", goBackToLobby);
    document.getElementById("btn-cancel-join").addEventListener("click", goBackToLobby);

    // --- Updated startNewGame to handle online modes ---
    const originalStartNewGame = startNewGame;
    startNewGame = async function() {
      const gameModeSelect = document.getElementById("game-mode-select");
      const gameMode = gameModeSelect ? gameModeSelect.value : "duel";
      const p1Select = document.getElementById("p1-dice-set");
      const p2Select = document.getElementById("p2-dice-set");
      const p1Set = p1Select ? p1Select.value : "numbers";
      const p2Set = p2Select ? p2Select.value : "numbers";

      if (gameMode === "online-host") {
        await startGameAsHost(p1Set, p2Set);
      } else if (gameMode === "online-join") {
        await startGameAsJoin(p1Set, p2Set);
      } else {
        // Solo oder Duell
        state.currentPlayer = 1;
        state.gameOver = false;
        state.gameMode = gameMode;
        state.players[1] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p1Set };
        state.players[2] = { reserve: 15, exile: 0, trigger: 0, victory: 0, diceSet: p2Set };

        initBoardState();
        buildBoardDOM();
        updateBoardDOM();
        refreshPlayerPanels();
        clearSelection();
        setStatus("Spieler 1 ist am Zug.");
        
        const lobbyOverlay = document.getElementById("lobby-overlay");
        lobbyOverlay.style.display = "none";
      }
    };
  </script>
</body>
</html>
